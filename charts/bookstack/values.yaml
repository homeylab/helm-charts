# Default values for bookstack.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

image:
  repository: docker.io
  name: linuxserver/bookstack
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: "23.08.3"

## set image for post install helm tests
testCurlImage:
  repository: docker.io
  name: busybox
  tag: "1.36.1"
  pullPolicy: IfNotPresent
  # the url for post install check test
  path: /status

updateStrategy:
  type: Recreate

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: false
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""

podAnnotations: {}

podSecurityContext: {}
  # fsGroup: 2000

securityContext: {}
  # capabilities:
  #   drop:
  #   - ALL
  # readOnlyRootFilesystem: true
  # runAsNonRoot: true
  # runAsUser: 1000

## existing secret for credentials
## if supplied, dbUser and dbPass will be ignored in config section
## You can also optionally set more credentials/secret env vars in this secret like APP_KEY
existingSecret: ""

## Default values below will work with included mariadb chart in bookstack namespace
config:
  ## (specify http/https) url used to access bookstack
  ## If using ingress, set it to same url
  ## example: "https://bookstack.yourdomain.org"
  appUrl: ""
  ## dbHost should be specified and consistent!
  ## If not included though, it will be dynamically generated and attempt to use included/embedded Bitnami mariadb instance
  ## This to help with chart-testing dynamic namespaces
  ## dbHost if not specified, value = "{{ bookstack.fullname/specified chart install name }}-mariadb.{{ .Release.Namespace }}.svc.cluster.local"
  ## Example value if installed in bookstack namespace: "bookstack-mariadb.bookstack.svc.cluster.local"
  dbHost: ""
  dbPort: 3306
  dbDatabase: bookstack
  ## Credentials below
  ## if existingSecret is specified, these will be ignored
  dbUser: bookstack
  dbPass: bookstack
  ## Cache & Session driver to use
  ## Can be 'file', 'database', 'memcached' or 'redis'
  cacheDriver: database
  sessionDriver: database


## Below options are used as env variables, choose any valid one Bookstack supports
## Ref: https://github.com/BookStackApp/BookStack/blob/development/.env.example.complete
## All keys will be upper cased and values will be quoted
## Some default values below for reference
extraEnv: {}
  # TZ: Etc/UTC
  # APP_DEFAULT_DARK_MODE: true
  # APP_VIEWS_BOOKS: list

service:
  type: ClusterIP
  port: 80
  name: http

ingress:
  enabled: false
  className: ""
  annotations:
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
  hosts:
    - host: bookstack.example.org
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: chart-example-tls
  #    hosts:
  #      - chart-example.local

persistence:
  enabled: true
  storageClass: ""
  size: 5Gi
  ## NOTE: When existingClaim is set the rest of persistence parameters are ignored
  existingClaim: ""
  accessModes:
    - ReadWriteOnce

resources: {}
  # We usually recommend not to specify default resources and to leave this as a conscious
  # choice for the user. This also increases chances charts run on environments with little
  # resources, such as Minikube. If you do want to specify resources, uncomment the following
  # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
  # limits:
  #   cpu: 100m
  #   memory: 128Mi
  # requests:
  #   cpu: 100m
  #   memory: 128Mi

## Ref: https://github.com/BookStackApp/BookStack/commit/6eda1c1fb28142d432bf0ca05d7eaba9bf16f0d0#diff-5782232ec3249cb816fc3f3332f8322e351f91d9cc590d717ab9e446536a1949
## Use `/status` path for checks

## Liveness probe
livenessProbe:
  httpGet:
    path: /status
    port: http
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 3
  failureThreshold: 5
  successThreshold: 1

## Readiness probe
readinessProbe:
  httpGet:
    path: /status
    port: http
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 2
  failureThreshold: 5
  successThreshold: 1

## Startup Probe
## Initial delay of 30 seconds to wait for mariadb
## long start up helps with chart-testing, change this as desired
## shorter periodSeconds helps with pod restarts for db timeout conditions
startupProbe:
  httpGet:
    path: /status
    port: http
  initialDelaySeconds: 30
  periodSeconds: 5
  timeoutSeconds: 2
  failureThreshold: 3
  successThreshold: 1

nodeSelector: {}

tolerations: []

affinity: {}

## file exporter for backups of pages
## https://github.com/homeylab/bookstack-file-exporter
## enable if you want to export all your pages to object storage like minio
fileBackups:
  enabled: false
  image:
    repository: docker.io
    name: homeylab/bookstack-file-exporter
    pullPolicy: IfNotPresent
    # Overrides the image tag whose default is the chart appVersion.
    tag: "0.0.2"
  ## default once per day
  cronSchedule: "@daily"
  ## existing secret for credentials loaded as env vars
  ## can use this secret for Bookstack credentials
  ## <BOOKSTACK_TOKEN_ID>, <BOOKSTACK_TOKEN_SECRET>
  ## also use for object storage credentials
  ## See ref for more details on how to get credentials: https://demo.bookstackapp.com/api/docs#authentication
  existingSecret: ""
  ## configuration options here: https://github.com/homeylab/bookstack-file-exporter#configuration-file
  config: |
    # The target bookstack instance
    # example value shown below
    # if http/https not specified, defaults to https
    # if you put http here, it will try verify=false, not to check certs
    host: "http://bookstack.bookstack.svc.cluster.local"

    # You could optionally set the bookstack token_id and token_secret here instead of env
    # if existingSecret is supplied, can omit/comment out the `credentials` section below
    credentials:
      # set here or as env variable, BOOKSTACK_TOKEN_ID
      # env var takes precedence over below
      token_id: ""
      # set here or as env variable, BOOKSTACK_TOKEN_SECRET
      # env var takes precedence over below
      token_secret: ""

    # additional headers to add, examples below
    # if not required, you can omit/comment out section
    additional_headers:
      User-Agent: "helm-bookstack-exporter"

    # supported formats from bookstack below
    # specify one or more
    # comment/remove the ones you do not need
    formats:
      - markdown
      - html
      - pdf
      - plaintext

    # if existingSecret is supplied, can omit/comment out the `minio_config._key` sections below
    minio_config:
      # a host/ip + port combination is also allowed
      # example: "minio.yourdomain.com:8443"
      host: "minio.yourdomain.com"
      # set here or as env variable, MINIO_ACCESS_KEY
      # env var takes precedence over below
      access_key: ""
      # set here or as env variable, MINIO_SECRET_KEY
      # env var takes precedence over below
      secret_key: ""
      # required by minio
      # if unsure, try "us-east-1"
      region: "us-east-1"
      # bucket to use
      bucket: "bookstack-bkps"
      # path to upload to
      # optional, will use root bucket path if not set
      # the exported archive will appear in: `<bucket_name>:<path>/bookstack_export_<timestamp>.tgz`
      path: "bookstack/file_backups/"
      # optional if specified exporter can delete older archives
      # valid values are:
      # set to 1+ if you want to retain a certain number of archives
      # set to 0 or comment out section if you want no action done
      keep_last: 5
    
    # optional export of metadata about the page in a json file
    # this metadata contains general information about the page
    # like: last update, owner, revision count, etc.
    # omit this or set to false if not needed
    export_meta: false

    # optional if specified exporter can delete older archives
    # valid values are:
    # set to -1 if you want to delete all archives after each run
    # - this is useful if you only want to upload to object storage
    # set to 1+ if you want to retain a certain number of archives
    # set to 0 or comment out section if you want no action done
    keep_last: -1
  
  ## All keys will be upper cased and values will be quoted
  extraEnv: {}
    # LOG_LEVEL: debug


## mariadb backend
## https://github.com/bitnami/charts/tree/main/bitnami/mariadb
## some basic options below but look at their chart for more
mariadb:
  enabled: true
  ## @param architecture MariaDB architecture (`standalone` or `replication`)
  ##
  architecture: standalone
  ## Mariadb Authentication parameters
  ##
  auth:
    ## @param auth.rootPassword Password for the `root` user. Ignored if existing secret is provided.
    ## ref: https://github.com/bitnami/containers/tree/main/bitnami/mariadb#setting-the-root-password-on-first-run
    ##
    rootPassword: ""
    ## @param auth.existingSecret Use existing secret for password details (`auth.rootPassword`, `auth.password`, `auth.replicationPassword` will be ignored and picked up from this secret). The secret has to contain the keys `mariadb-root-password`, `mariadb-replication-password` and `mariadb-password`
    ##
    existingSecret: ""
    ## @param auth.database Name for a custom database to create
    ## ref: https://github.com/bitnami/containers/blob/main/bitnami/mariadb/README.md#creating-a-database-on-first-run
    ##
    database: "bookstack"
    ## @param auth.username Name for a custom user to create
    ## ref: https://github.com/bitnami/containers/blob/main/bitnami/mariadb/README.md#creating-a-database-user-on-first-run
    ##
    username: "bookstack"
    ## @param auth.password Password for the new user. Ignored if existing secret is provided
    ##
    password: "bookstack"
  ## Enable persistence using Persistent Volume Claims
  ## ref: https://kubernetes.io/docs/user-guide/persistent-volumes/
  ##
  primary:
    persistence:
      ## @param primary.persistence.enabled Enable persistence on MariaDB primary replicas using a `PersistentVolumeClaim`. If false, use emptyDir
      ##
      enabled: true
      ## @param primary.persistence.existingClaim Name of an existing `PersistentVolumeClaim` for MariaDB primary replicas
      ## NOTE: When it's set the rest of persistence parameters are ignored
      ##
      existingClaim: ""
      ## @param primary.persistence.subPath Subdirectory of the volume to mount at
      ##
      subPath: ""
      ## @param primary.persistence.storageClass MariaDB primary persistent volume storage Class
      ## If defined, storageClassName: <storageClass>
      ## If set to "-", storageClassName: "", which disables dynamic provisioning
      ## If undefined (the default) or set to null, no storageClassName spec is
      ##   set, choosing the default provisioner.  (gp2 on AWS, standard on
      ##   GKE, AWS & OpenStack)
      ##
      storageClass: ""
      ## @param primary.persistence.labels Labels for the PVC
      ##
      labels: {}
      ## @param primary.persistence.annotations MariaDB primary persistent volume claim annotations
      ##
      annotations: {}
      ## @param primary.persistence.accessModes MariaDB primary persistent volume access Modes
      ##
      accessModes:
        - ReadWriteOnce
      ## @param primary.persistence.size MariaDB primary persistent volume size
      ##
      size: 5Gi
      ## @param primary.persistence.selector Selector to match an existing Persistent Volume
      ## selector:
      ##   matchLabels:
      ##     app: my-app
      ##
      selector: {}
    
  metrics:
    ## @param metrics.enabled Start a side-car prometheus exporter
    ##
    enabled: false
    ## Prometheus Service Monitor
    ## ref: https://github.com/coreos/prometheus-operator
    ##
    serviceMonitor:
      ## @param metrics.serviceMonitor.enabled Create ServiceMonitor Resource for scraping metrics using PrometheusOperator
      ##
      enabled: false
      ## @param metrics.serviceMonitor.labels Used to pass Labels that are used by the Prometheus installed in your cluster to select Service Monitors to work with
      ## ref: https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#prometheusspec
      ##
      labels:
        app: mariadb
    ## Prometheus Operator PrometheusRule configuration
    ##
    prometheusRule:
      ## @param metrics.prometheusRule.enabled if `true`, creates a Prometheus Operator PrometheusRule (also requires `metrics.enabled` to be `true` and `metrics.prometheusRule.rules`)
      ##
      enabled: false
      ## @param metrics.prometheusRule.namespace Namespace for the PrometheusRule Resource (defaults to the Release Namespace)
      ##
      namespace: ""
      ## @param metrics.prometheusRule.additionalLabels Additional labels that can be used so PrometheusRule will be discovered by Prometheus
      ##
      additionalLabels: {}
      ## @param metrics.prometheusRule.rules Prometheus Rule definitions
      ##  - alert: MariaDB-Down
      ##    expr: absent(up{job="mariadb"} == 1)
      ##    for: 5m
      ##    labels:
      ##      severity: warning
      ##      service: mariadb
      ##    annotations:
      ##      message: 'MariaDB instance {{ `{{` }} $labels.instance {{ `}}` }} is down'
      ##      summary: MariaDB instance is down
      ##
      rules: []